# Архитектура проекта

## Общая структура
```
DataStream-MySQL-&-Clickhouse/
│
├── app/                      # Основной код приложения
│   ├── db/                   # Модули для работы с БД
│   │   ├── __init__.py
│   │   ├── clickhouse.py     # Работа с ClickHouse
│   │   └── mysql.py          # Работа с MySQL
│   │
│   ├── models/               # Модели данных
│   │   ├── __init__.py
│   │   └── service_db.py     # Модели сервисных таблиц
│   │
│   ├── services/             # Бизнес-логика 
│   │   ├── __init__.py
│   │   ├── data_service.py   # Сервис для обработки данных
│   │   └── sync_service.py   # Сервис для синхронизации данных
│   │
│   ├── __init__.py
│   ├── config.py             # Конфигурация приложения
│   └── main.py               # Точка входа приложения
│
├── dags/                     # DAG-и для Airflow
│   ├── data_sync_dag.py      # DAG для синхронизации данных
│   └── mysql_to_clickhouse_etl.py # DAG для ETL процесса
│
├── test_data.sql             # Скрипт для создания тестовых данных в MySQL
├── clickhouse_schema.sql     # Схема таблиц и представлений для ClickHouse
└── requirements.txt          # Зависимости проекта
```

## Структура проекта

### Корневые директории
- `/app` - основной код приложения
- `/dags` - DAG-файлы для Airflow
- `/config` - конфигурации
- `/logs` - логи
- `/plugins` - плагины для Airflow

### Основные компоненты

#### Модуль `/app/db`
Содержит классы для работы с базами данных:
- `mysql.py` - клиенты для взаимодействия с MySQL:
  - `ServiceDBClient` - для работы с сервисной БД (получение настроек подключений)
  - `MySQLClient` - для работы с конкретной MySQL базой данных

#### Модуль `/app/models`
Содержит модели данных:
- `service_db.py` - модели для работы с сервисной БД (описание соединений, структур таблиц)

#### Модуль `/app/services`
Содержит бизнес-логику:
- `sync_service.py` - сервис для синхронизации данных между MySQL и ClickHouse

#### Модуль `/app/scripts`
Содержит скрипты для выполнения различных задач

### DAGs
- `mysql_to_clickhouse_etl.py` - DAG для ETL процесса из MySQL в ClickHouse с использованием собственных клиентов
- `data_sync_dag.py` - DAG для синхронизации данных из MySQL в ClickHouse через сервис синхронизации
- `test1_dag.py` - Тестовый DAG

## Процессы

### ETL процесс
1. Извлечение данных из MySQL (`extract_mysql_data`)
2. Загрузка данных в ClickHouse (`load_to_clickhouse`)
3. Обновление материализованных представлений (`refresh_materialized_views`)

### Синхронизация данных
1. Проверка наличия активных подключений (`check_connections`)
2. Синхронизация данных через сервис синхронизации (`sync_data`)
3. Анализ результатов синхронизации (`analyze_results`)

## Технический стек
- Apache Airflow 3.0 - оркестратор процессов
- MySQL - источник данных
- ClickHouse - целевое хранилище для аналитики
- Python 3.12 - язык программирования
- loguru - библиотека для логирования