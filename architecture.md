# Архитектура проекта

## Общая структура
```
DataStream-MySQL-&-Clickhouse/
│
├── app/                      # Основной код приложения
│   ├── db/                   # Модули для работы с БД
│   │   ├── __init__.py
│   │   ├── clickhouse.py     # Работа с ClickHouse
│   │   ├── merge_config.py   # Конфигурация ключевых полей для слияния данных
│   │   └── mysql.py          # Работа с MySQL
│   │
│   ├── models/               # Модели данных
│   │   ├── __init__.py
│   │   └── service_db.py     # Модели сервисных таблиц
│   │
│   ├── services/             # Бизнес-логика 
│   │   ├── __init__.py
│   │   ├── data_service.py   # Сервис для обработки данных
│   │   └── sync_service.py   # Сервис для синхронизации данных
│   │
│   ├── __init__.py
│   ├── config.py             # Конфигурация приложения
│   └── main.py               # Точка входа приложения
│
├── dags/                     # DAG-и для Airflow
│   ├── data_sync_dag.py      # DAG для синхронизации данных
│   └── mysql_to_clickhouse_etl.py # DAG для ETL процесса
│
├── test_data.sql             # Скрипт для создания тестовых данных в MySQL
├── clickhouse_schema.sql     # Схема таблиц и представлений для ClickHouse
└── requirements.txt          # Зависимости проекта
```

## Структура проекта

### Корневые директории
- `/app` - основной код приложения
- `/dags` - DAG-файлы для Airflow
- `/config` - конфигурации
- `/logs` - логи
- `/plugins` - плагины для Airflow

### Основные компоненты

#### Модуль `/app/db`
Содержит классы для работы с базами данных:
- `mysql.py` - клиенты для взаимодействия с MySQL:
  - `ServiceDBClient` - для работы с сервисной БД (получение настроек подключений)
  - `MySQLClient` - для работы с конкретной MySQL базой данных
- `clickhouse.py` - клиент для работы с ClickHouse:
  - `ClickHouseClient` - управление данными в ClickHouse
  - Функции для преобразования типов данных из MySQL в ClickHouse
  - Методы для обновления и вставки данных
- `merge_config.py` - конфигурация ключевых полей для идентификации записей:
  - Словарь с ключевыми полями для каждой таблицы
  - Функция для получения ключевых полей таблицы

#### Модуль `/app/models`
Содержит модели данных:
- `service_db.py` - модели для работы с сервисной БД (описание соединений, структур таблиц)

#### Модуль `/app/services`
Содержит бизнес-логику:
- `sync_service.py` - сервис для синхронизации данных между MySQL и ClickHouse
- `data_service.py` - сервис для обработки данных и их преобразования

#### Модуль `/app/scripts`
Содержит скрипты для выполнения различных задач

### DAGs
- `mysql_to_clickhouse_etl.py` - DAG для ETL процесса из MySQL в ClickHouse с использованием собственных клиентов
- `data_sync_dag.py` - DAG для синхронизации данных из MySQL в ClickHouse через сервис синхронизации
- `test1_dag.py` - Тестовый DAG

## Процессы

### ETL процесс
1. Извлечение данных из MySQL (`extract_mysql_data`)
2. Обновление данных в ClickHouse с помощью эффективного механизма слияния (`load_to_clickhouse`)
3. Обновление материализованных представлений (`refresh_materialized_views`)

### Синхронизация данных
1. Проверка наличия активных подключений (`check_connections`)
2. Синхронизация данных через сервис синхронизации (`sync_data`)
3. Анализ результатов синхронизации (`analyze_results`)

## Механизм обновления данных в ClickHouse

### Архитектура обновления данных
Система использует эффективный механизм обновления данных в ClickHouse:

1. **Идентификация записей**:
   - Для каждой таблицы определены ключевые поля в файле `merge_config.py`
   - По этим полям определяется уникальность записей

2. **Процесс обновления**:
   - Использование временных таблиц для эффективной пакетной обработки
   - DELETE + INSERT стратегия для обновления данных
   - Механизм пакетной обработки для больших объемов данных

3. **Особенности реализации**:
   - Автоматическое деление данных на пакеты для обработки больших объемов
   - Поддержка многих подключений к MySQL с одинаковой структурой таблиц
   - Хранение источника данных в поле `_source_database` для каждой записи

## Технический стек
- Apache Airflow 3.0 - оркестратор процессов
- MySQL - источник данных
- ClickHouse - целевое хранилище для аналитики
- Python 3.12 - язык программирования
- loguru - библиотека для логирования