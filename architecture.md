# Архитектура проекта

## Общая структура
```
DataStream-MySQL-&-Clickhouse/
│
├── app/                      # Основной код приложения
│   ├── db/                   # Модули для работы с БД
│   │   ├── __init__.py
│   │   ├── clickhouse.py     # Работа с ClickHouse
│   │   ├── merge_config.py   # Конфигурация ключевых полей для слияния данных
│   │   └── mysql.py          # Работа с MySQL
│   │
│   ├── models/               # Модели данных
│   │   ├── __init__.py
│   │   └── service_db.py     # Модели сервисных таблиц
│   │
│   ├── services/             # Бизнес-логика 
│   │   ├── __init__.py
│   │   ├── data_service.py   # Сервис для обработки данных
│   │   └── sync_service.py   # Сервис для синхронизации данных
│   │
│   ├── __init__.py
│   ├── config.py             # Конфигурация приложения
│   └── main.py               # Точка входа приложения
│
├── dags/                     # DAG-и для Airflow
│   ├── data_sync_dag.py      # DAG для синхронизации данных
│   └── mysql_to_clickhouse_etl.py # DAG для ETL процесса
│
├── test_data.sql             # Скрипт для создания тестовых данных в MySQL
├── clickhouse_schema.sql     # Схема таблиц и представлений для ClickHouse
└── requirements.txt          # Зависимости проекта
```

## Структура проекта

### Корневые директории
- `/app` - основной код приложения
- `/dags` - DAG-файлы для Airflow
- `/config` - конфигурации
- `/logs` - логи
- `/plugins` - плагины для Airflow

### Основные компоненты

#### Модуль `/app/db`
Содержит классы для работы с базами данных:
- `mysql.py` - клиенты для взаимодействия с MySQL:
  - `ServiceDBClient` - для работы с сервисной БД (получение настроек подключений)
  - `MySQLClient` - для работы с конкретной MySQL базой данных
- `clickhouse.py` - клиент для работы с ClickHouse:
  - `ClickHouseClient` - управление данными в ClickHouse с использованием ReplacingMergeTree
  - Функции для преобразования типов данных из MySQL в ClickHouse
  - Методы для эффективного обновления и вставки данных с версионированием
  - Методы для оптимизации таблиц и получения актуальных данных
- `merge_config.py` - конфигурация ключевых полей для идентификации записей:
  - Словарь с ключевыми полями для каждой таблицы
  - Функция для получения ключевых полей таблицы

#### Модуль `/app/models`
Содержит модели данных:
- `service_db.py` - модели для работы с сервисной БД (описание соединений, структур таблиц)

#### Модуль `/app/services`
Содержит бизнес-логику:
- `sync_service.py` - сервис для синхронизации данных между MySQL и ClickHouse
- `data_service.py` - сервис для обработки данных и их преобразования

#### Модуль `/app/scripts`
Содержит скрипты для выполнения различных задач

### DAGs
- `mysql_to_clickhouse_etl.py` - DAG для ETL процесса из MySQL в ClickHouse с использованием собственных клиентов
- `data_sync_dag.py` - DAG для синхронизации данных из MySQL в ClickHouse через сервис синхронизации
- `test1_dag.py` - Тестовый DAG

## Процессы

### ETL процесс
1. Извлечение данных из MySQL (`extract_mysql_data`)
2. Обновление данных в ClickHouse с помощью ReplacingMergeTree (`load_to_clickhouse`)
3. Обновление материализованных представлений (`refresh_materialized_views`)

### Синхронизация данных
1. Проверка наличия активных подключений (`check_connections`)
2. Синхронизация данных через сервис синхронизации (`sync_data`)
3. Анализ результатов синхронизации (`analyze_results`)

## Механизм обновления данных в ClickHouse

### Архитектура ReplacingMergeTree
Система использует эффективный движок ClickHouse **ReplacingMergeTree** для автоматического управления обновлениями:

1. **Структура таблиц**:
   - Основные данные из MySQL
   - `_source_database` - поле для указания источника данных
   - `_version` - версионный столбец (timestamp в микросекундах)
   - ORDER BY настроен по ключевым полям из `merge_config.py`

2. **Принцип работы ReplacingMergeTree**:
   ```sql
   ENGINE = ReplacingMergeTree(_version)
   ORDER BY (id, name)  -- ключевые поля
   ```
   - При вставке данных с одинаковыми ключевыми полями, новая запись помечается как замена
   - Во время background merge операций старые записи автоматически удаляются
   - Остается только запись с максимальной версией

3. **Процесс обновления данных**:
   - **INSERT операция**: Простая вставка с новой версией (timestamp)
   - **Автоматическое слияние**: ClickHouse сам управляет дедупликацией
   - **Принудительное слияние**: `OPTIMIZE TABLE ... FINAL` для немедленного применения

4. **Версионирование**:
   - Каждая запись получает уникальную версию: `int(time.time() * 1000000)`
   - Микросекунды обеспечивают уникальность версий даже для быстрых операций
   - Пакетные операции используют инкрементные версии для порядка

### Ключевые методы ClickHouseClient

1. **create_table()**: 
   - Создает таблицы с движком `ReplacingMergeTree(_version)`
   - Автоматически настраивает ORDER BY на основе ключевых полей
   - Добавляет служебные поля `_source_database` и `_version`

2. **merge_data()**: 
   - Простая INSERT операция с версионированием
   - Автоматическое добавление timestamp версии
   - Движок сам управляет заменой дублей

3. **batch_merge_data()**:
   - Пакетная обработка больших объемов данных
   - Инкрементные версии для поддержания порядка в пакете

4. **optimize_table()**:
   - Принудительное слияние для немедленного применения замен
   - Полезно после больших загрузок данных

5. **get_latest_data()**:
   - Получение актуальных данных с использованием FINAL
   - Возвращает только последние версии записей

### Преимущества ReplacingMergeTree подхода

1. **Простота**: Нет сложной логики с временными таблицами
2. **Производительность**: ClickHouse оптимизирован для таких операций
3. **Надежность**: Встроенные механизмы дедупликации
4. **Масштабируемость**: Эффективная работа с большими объемами данных
5. **Консистентность**: Автоматическое управление версиями

### Получение актуальных данных

Для получения только последних версий записей:

```sql
-- Быстрый способ (для небольших объемов)
SELECT * FROM table_name FINAL

-- Оптимальный способ (для больших объемов)
SELECT * FROM (
    SELECT *, ROW_NUMBER() OVER (PARTITION BY key_fields ORDER BY _version DESC) as rn
    FROM table_name
) WHERE rn = 1
```

## Технический стек
- Apache Airflow 3.0 - оркестратор процессов
- MySQL - источник данных
- ClickHouse - целевое хранилище для аналитики (ReplacingMergeTree)
- Python 3.12 - язык программирования
- loguru - библиотека для логирования
- clickhouse-connect - драйвер для ClickHouse